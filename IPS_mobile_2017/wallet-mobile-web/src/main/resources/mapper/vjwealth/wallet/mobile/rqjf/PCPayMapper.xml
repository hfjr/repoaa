<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://www.mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhuanyi.vjwealth.wallet.mobile.rqjf.server.mapper.IPCPayMapper">

	
	
	<insert id="saveTradeRecord" parameterType="java.lang.String">
		INSERT INTO wj_payment_trade_record (
			trade_no,
			total_price,
			price,
			fee,
			trade_stauts,
			rel_biz_order_no,
			rel_biz_order_status,
			rel_biz_mesage,
			bank_card_no,
			plateform_id,
			confrim_balance_flag,
			create_date,
			create_by
		)
		VALUES
		(
			#{tradeNo},
			#{amt},
			#{amt},
			'0.0000',
			'trade_process',
			#{orderNo},
			NULL,
			NULL,
			'',
			'paychannel008',
			'N',
			now(),
			'SYSTEM'
		)
	</insert>
	
	<insert id="saveEbatongRecord" parameterType="java.lang.String">
		INSERT INTO wj_ebatong_trade_history (
			out_trade_no,
			amount,
			user_id,
			plateform_id,
			mer_date,
			pay_type,
			create_date,
			create_by
		)
		VALUES
		(
			#{tradeNo},
			#{amt},
			#{userId},
			'paychannel008',
			DATE_FORMAT(now(),'%Y%m%d'),
			'80',
			now(),
			'SYSTEM'
		)
	</insert>
	
	
	<insert id="saveRechargeOrder" parameterType="java.lang.String">
		INSERT INTO wj_order (
			user_id,
			order_no,
			title,
			total_price,
			price,
			fee,
			virtual_amount,
			activity_amount,
			order_status,
			product_id,
			trade_account_id,
			trade_account_card_id,
			order_type,
			order_token,
			channel_trade_id,
			create_date,
			create_by,
			time_financial_approval,
			time_confirm,
			contrast_flag,
			rel_order_no,
			is_redeem,
			is_apply
		)
		VALUES
			(
			#{userId},
			#{orderNo},
			'充值中',
			#{amt},
			#{amt},
			'0.0000',
			'0.0000',
			'0.0000',
			'pc_recharge_ma_confirm_dispose',
			NULL,
			NULL,
			'',
			'pc_recharge_ma',
			NULL,
			NULL,
			now(),
			'SYSTEM',
			NULL,
			NULL,
			'N',
			NULL,
			'N',
			'N'
		)
	</insert>
	
	
		
	 <select id="getOrderInfo" parameterType="java.lang.String"  resultType="java.util.HashMap" >
		SELECT
			t.user_id AS userId,
			CONCAT(t.total_price, '') AS totalPrice,
			t.order_no as orderNo
		FROM
			wj_order t,wj_payment_trade_record p
		WHERE
			p.trade_no =#{tradeNo}
		and t.order_no=p.rel_biz_order_no
	  </select>
	
	 <select id="countOrderRechargeStatus" parameterType="java.lang.String"  resultType="java.lang.Integer" >
		 SELECT
			count(1)
		FROM
			wj_order tt
		WHERE
			tt.user_id = #{userId}
		and tt.order_no=#{orderNo}
		AND tt.order_status='pc_recharge_ma_confirm'
	  </select>
	  
	  
 	 <update id="updatePCRechargeOrderStatus" parameterType="java.lang.String"   >
			update wj_order 
			set order_status='pc_recharge_ma_confirm',
			title='网关充值成功'
			where order_no=#{orderNo}
			and user_id=#{userId}
	  </update>
	  
	  
	   <update id="addUserMaAvailableAmount" parameterType="java.lang.String"   >
			update wj_user_trade_account 
			set available_amount=available_amount+#{amt}
			where user_id=#{userId}
			and trade_type='ma'
	  </update>
	  
 	 <update id="updatePaymentTradeStatus" parameterType="java.lang.String"   >
			update wj_payment_trade_record 
			set trade_stauts='trade_success',
			rel_biz_order_status='biz_success',
			rel_biz_mesage='充值成功'
			where rel_biz_order_no=#{orderNo}
	  </update>
	
</mapper>